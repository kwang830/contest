<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BBSManageDAO">


	<resultMap id="boardList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="inqireCo" column="RDCNT"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>		
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="teamNm" column="TEAM_NM"/>
		<result property="imgUrl" column="IMG_URL"/>
		<result property="selectImg" column="SELECT_IMG"/>
	</resultMap>

	<resultMap id="boardVoteList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="inqireCo" column="RDCNT"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="teamNm" column="TEAM_NM"/>
		<result property="imgUrl" column="IMG_URL"/>
		<result property="selectImg" column="SELECT_IMG"/>
		<result property="score" column="SCORE"/>
		<result property="scoreA" column="SCORE_A"/>
		<result property="scoreCnt" column="SCORE_CNT"/>
		<result property="commentCnt" column="COMMENT_CNT"/>
	</resultMap>

	<resultMap id="boardDetail" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>	
		<result property="ntcrId" column="NTCR_ID"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="nttNo" column="NTT_NO"/>
		<result property="nttCn" column="NTT_CN"/>
		<result property="password" column="PASSWORD"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="lastUpdusrPnttm" column="LAST_UPDUSR_PNTTM"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="inqireCo" column="RDCNT"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>		
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="sortOrdr" column="SORT_ORDR"/>
		<result property="bbsTyCode" column="BBS_TY_CODE"/>
		<result property="bbsAttrbCode" column="BBS_ATTRB_CODE"/>
		<result property="replyPosblAt" column="REPLY_POSBL_AT"/>
		<result property="fileAtchPosblAt" column="FILE_ATCH_POSBL_AT"/>
		<result property="posblAtchFileNumber" column="ATCH_POSBL_FILE_NUMBER"/>
		<result property="bbsNm" column="BBS_NM"/>
		<result property="teamNm" column="TEAM_NM"/>
		<result property="imgUrl" column="IMG_URL"/>
		<result property="selectImg" column="SELECT_IMG"/>
	</resultMap>

	<resultMap id="boardVoteDetail" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="ntcrId" column="NTCR_ID"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="nttNo" column="NTT_NO"/>
		<result property="nttCn" column="NTT_CN"/>
		<result property="password" column="PASSWORD"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="inqireCo" column="RDCNT"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="sortOrdr" column="SORT_ORDR"/>
		<result property="bbsTyCode" column="BBS_TY_CODE"/>
		<result property="bbsAttrbCode" column="BBS_ATTRB_CODE"/>
		<result property="replyPosblAt" column="REPLY_POSBL_AT"/>
		<result property="fileAtchPosblAt" column="FILE_ATCH_POSBL_AT"/>
		<result property="posblAtchFileNumber" column="ATCH_POSBL_FILE_NUMBER"/>
		<result property="bbsNm" column="BBS_NM"/>
		<result property="teamNm" column="TEAM_NM"/>
		<result property="imgUrl" column="IMG_URL"/>
		<result property="selectImg" column="SELECT_IMG"/>
		<result property="score" column="SCORE"/>
		<result property="scoreA" column="SCORE_A"/>
		<result property="scoreCnt" column="SCORE_CNT"/>
		<result property="commentCnt" column="COMMENT_CNT"/>
	</resultMap>

	<resultMap id="sortList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="sortOrdr" column="SORT_ORDR"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="nttNo" column="NTT_NO"/>		
		<result property="replyLc" column="ANSWER_LC"/>
	</resultMap>

	<resultMap id="guestList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="password" column="PASSWORD"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="nttCn" column="NTT_CN"/>
		<result property="useAt" column="USE_AT"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
	</resultMap>

	<resultMap id="valtBbsList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="teamNm" column="TEAM_NM"/>
	</resultMap>

	<resultMap id="commentList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="nttId" column="NTT_ID"/>
		<result property="bbsId" column="BBS_ID"/>
		<result property="answerNo" column="ANSWER_NO"/>
		<result property="ntcrId" column="NTCR_ID"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="answer" column="ANSWER"/>
		<result property="useAt" column="USE_AT"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="imgUrl" column="IMG_URL"/>
		<result property="teamNm" column="TEAM_NM"/>
		<result property="titleNm" column="TITLE_NM"/>
	</resultMap>

	<resultMap id="scoreList" type="egovframework.let.cop.bbs.service.BoardVO">
		<result property="score" column="SCORE"/>
		<result property="scoreCnt" column="SCORE_CNT"/>
	</resultMap>

 	<select id="selectMaxNttId" resultType="java.lang.Long">
 		
			SELECT IFNULL(MAX(NTT_ID),0)+1 AS NTT_ID  FROM LETTNBBS
 		
 	</select>
 	
	<insert id="insertBoardArticle" parameterType="egovframework.let.cop.bbs.service.Board">
		<selectKey keyProperty="nttNo" resultType="java.lang.Long" order="BEFORE">
			SELECT IFNULL(MAX(SORT_ORDR),0)+1 AS NTT_NO  FROM LETTNBBS
			WHERE BBS_ID = #{bbsId}
		</selectKey>
		
			INSERT INTO LETTNBBS
			(NTT_ID, BBS_ID, NTT_SJ, NTT_CN, SORT_ORDR, 
			 NTCR_ID, NTCR_NM, PASSWORD, RDCNT, 
			 NTCE_BGNDE, NTCE_ENDDE, ANSWER_AT,  			   
			 PARNTSCTT_NO, NTT_NO, ANSWER_LC, ATCH_FILE_ID,
			 FRST_REGISTER_ID, FRST_REGIST_PNTTM, USE_AT, TEAM_NM, IMG_URL, SELECT_IMG
			 )
			VALUES
			( #{nttId}, #{bbsId}, #{nttSj}, #{nttCn}, #{nttNo}, 
			  #{ntcrId}, #{ntcrNm}, #{password}, #{inqireCo}, 
			  #{ntceBgnde}, #{ntceEndde}, #{replyAt}, 
			  #{parnts}, 1, #{replyLc}, #{atchFileId},
			  #{frstRegisterId}, SYSDATE(), 'Y', #{teamNm}, #{imgUrl}, #{selectImg}
			 )			
		
	</insert>
	
	<insert id="replyBoardArticle" parameterType="egovframework.let.cop.bbs.service.Board">
		<selectKey keyProperty="nttNo" resultType="java.lang.Long" order="BEFORE">
			SELECT IFNULL(MAX(NTT_NO),0)+1 AS NTT_NO  FROM LETTNBBS
			WHERE BBS_ID = #{bbsId} AND SORT_ORDR = #{sortOrdr}
		</selectKey>			
		
			INSERT INTO LETTNBBS
			(NTT_ID, BBS_ID, NTT_SJ, NTT_CN, SORT_ORDR, 
			 NTCR_ID, NTCR_NM, PASSWORD, RDCNT, 
			 NTCE_BGNDE, NTCE_ENDDE, ANSWER_AT,  			   
			 PARNTSCTT_NO, NTT_NO, ANSWER_LC, ATCH_FILE_ID,
			 FRST_REGISTER_ID, FRST_REGIST_PNTTM, USE_AT
			 )
			VALUES
			( #{nttId}, #{bbsId}, #{nttSj}, #{nttCn}, #{sortOrdr}, 
			  #{ntcrId}, #{ntcrNm}, #{password}, #{inqireCo}, 
			  #{ntceBgnde}, #{ntceEndde}, #{replyAt}, 
			  #{parnts}, 1, #{replyLc}, #{atchFileId},
			  #{frstRegisterId}, SYSDATE(), 'Y'
			 )			
		
	</insert>	
	
	<select id="selectNoticeListForSort" parameterType="egovframework.let.cop.bbs.service.Board" resultMap="sortList">
					
			SELECT
				a.BBS_ID, a.NTT_ID, a.SORT_ORDR, a.PARNTSCTT_NO, a.NTT_NO, a.ANSWER_LC
			FROM
				LETTNBBS a	
			WHERE
				a.BBS_ID = #{bbsId}
			AND
				a.SORT_ORDR = #{sortOrdr}
			ORDER BY  a.SORT_ORDR DESC, a.NTT_NO ASC	
								
	</select>

			
	<select id="selectBoardArticleList" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="boardList">
		
			SELECT
                a.NTT_ID, a.NTT_SJ, a.NTT_CN, a.FRST_REGISTER_ID, IFNULL(b.USER_NM, a.NTCR_NM) as FRST_REGISTER_NM,
                DATE_FORMAT(a.FRST_REGIST_PNTTM, '%Y-%m-%d') as FRST_REGIST_PNTTM,
                a.RDCNT, a.PARNTSCTT_NO, a.ANSWER_AT, a.ANSWER_LC, a.USE_AT, a.ATCH_FILE_ID,
                a.BBS_ID, a.NTCE_BGNDE, a.NTCE_ENDDE, a.TEAM_NM, a.IMG_URL, a.SELECT_IMG
            FROM
                LETTNBBS a
            LEFT OUTER JOIN 
                COMVNUSERMASTER b
            ON a.FRST_REGISTER_ID = b.ESNTL_ID 
			WHERE
				a.BBS_ID = #{bbsId}
			
			<if test="frstRegisterId != ''">AND
				a.FRST_REGISTER_ID = #{frstRegisterId}
			</if>
			<if test="useAt != ''">AND
				a.USE_AT = #{useAt}
			</if>
			<if test="searchCnd == 0">AND
				a.NTT_SJ LIKE CONCAT ('%', #{searchWrd},'%')
			</if>
			<if test="searchCnd == 1">AND
				a.NTT_CN LIKE CONCAT ('%', #{searchWrd},'%')
			</if>	
			<if test="searchCnd == 2">AND
				b.USER_NM LIKE CONCAT ('%', #{searchWrd},'%')
			</if>				
					
			ORDER BY a.SORT_ORDR DESC, NTT_NO ASC
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
						
	</select>

	<select id="selectBoardVoteArticleList" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="boardVoteList">

		SELECT
		a.NTT_ID, a.NTT_SJ, a.NTT_CN, a.FRST_REGISTER_ID, IFNULL(b.USER_NM, a.NTCR_NM) as FRST_REGISTER_NM,
		DATE_FORMAT(a.FRST_REGIST_PNTTM, '%Y-%m-%d') as FRST_REGIST_PNTTM,
		a.RDCNT, a.PARNTSCTT_NO, a.ANSWER_AT, a.ANSWER_LC, a.USE_AT, a.ATCH_FILE_ID,
		a.BBS_ID, a.NTCE_BGNDE, a.NTCE_ENDDE, a.TEAM_NM, a.IMG_URL, a.SELECT_IMG
		, (SELECT IFNULL((SELECT c.score FROM lettnbbsscore c WHERE c.NTT_ID = a.NTT_ID AND c.BBS_ID = a.BBS_ID AND c.WRTER_ID = #{exmnId} AND c.USE_AT = 'Y' LIMIT 1), 0)) AS SCORE
		, (SELECT IFNULL((SELECT ROUND(AVG(c.score), 1) FROM lettnbbsscore c WHERE c.NTT_ID = a.NTT_ID AND c.BBS_ID = a.BBS_ID AND c.USE_AT = 'Y' LIMIT 1), 0)) AS SCORE_A
		, (SELECT count(1) FROM lettnbbsscore c WHERE c.NTT_ID = a.NTT_ID AND c.BBS_ID = a.BBS_ID AND c.USE_AT = 'Y' LIMIT 1) AS SCORE_CNT
	    , (SELECT count(1) FROM lettncomment c WHERE c.NTT_ID = a.NTT_ID AND c.BBS_ID = a.BBS_ID AND c.USE_AT = 'Y' LIMIT 1) AS COMMENT_CNT
		FROM
		LETTNBBS a
		LEFT OUTER JOIN
		COMVNUSERMASTER b
		ON a.FRST_REGISTER_ID = b.ESNTL_ID
		WHERE
		a.BBS_ID = #{bbsId}

		<if test="useAt != ''">AND
			a.USE_AT = #{useAt}
		</if>
		<if test="searchCnd == 0">AND
			a.NTT_SJ LIKE CONCAT ('%', #{searchWrd},'%')
		</if>
		<if test="searchCnd == 1">AND
			a.NTT_CN LIKE CONCAT ('%', #{searchWrd},'%')
		</if>
		<if test="searchCnd == 2">AND
			b.USER_NM LIKE CONCAT ('%', #{searchWrd},'%')
		</if>

		ORDER BY a.SORT_ORDR DESC, NTT_NO ASC
		LIMIT #{recordCountPerPage} OFFSET #{firstIndex}

	</select>

	<select id="selectBoardArticleListCnt" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultType="java.lang.Integer">
		
			SELECT
				COUNT(a.NTT_ID)
			FROM
				LETTNBBS a
			LEFT OUTER JOIN 
				COMVNUSERMASTER b
			ON a.FRST_REGISTER_ID = b.ESNTL_ID 
			WHERE
				a.BBS_ID = #{bbsId}

			<if test="frstRegisterId != ''">AND
				a.FRST_REGISTER_ID = #{frstRegisterId}
			</if>
			<if test="useAt != ''">AND
				a.USE_AT = #{useAt}
			</if>
			<if test="searchCnd == 0">AND
				a.NTT_SJ LIKE CONCAT ('%', #{searchWrd},'%')
			</if>
			<if test="searchCnd == 1">AND
				a.NTT_CN LIKE CONCAT ('%', #{searchWrd},'%')
			</if>	
			<if test="searchCnd == 2">AND
				b.USER_NM LIKE CONCAT ('%', #{searchWrd},'%')
			</if>			
	</select>	
 
	<select id="selectBoardArticle" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="boardDetail">
		
			SELECT
				a.NTT_SJ, a.NTCR_ID, a.NTCR_NM, a.NTT_NO, a.NTT_CN,
				a.PASSWORD, a.FRST_REGISTER_ID, b.USER_NM as FRST_REGISTER_NM,
				DATE_FORMAT(a.FRST_REGIST_PNTTM, '%Y-%m-%d') as FRST_REGIST_PNTTM,
				DATE_FORMAT(a.LAST_UPDT_PNTTM, '%Y-%m-%d') as LAST_UPDUSR_PNTTM,
				a.NTCE_BGNDE, a.NTCE_ENDDE, a.RDCNT, 
				a.USE_AT, a.ATCH_FILE_ID, a.BBS_ID, a.NTT_ID,
				a.PARNTSCTT_NO, a.ANSWER_AT, a.ANSWER_LC, a.SORT_ORDR,
				c.BBS_TY_CODE, c.BBS_ATTRB_CODE, c.REPLY_POSBL_AT, 
				c.FILE_ATCH_POSBL_AT, c.ATCH_POSBL_FILE_NUMBER, c.BBS_NM, a.TEAM_NM, a.IMG_URL, a.SELECT_IMG
			FROM
				LETTNBBS a
			LEFT OUTER JOIN 
				COMVNUSERMASTER b
			ON a.FRST_REGISTER_ID = b.ESNTL_ID 
			LEFT OUTER JOIN 
				LETTNBBSMASTER c
			ON a.BBS_ID = c.BBS_ID			
			WHERE
				a.BBS_ID = #{bbsId}	
			AND
				a.NTT_ID = #{nttId}	
						
	</select>

	<select id="selectBoardVoteArticle" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="boardVoteDetail">

		SELECT
			a.NTT_SJ, a.NTCR_ID, a.NTCR_NM, a.NTT_NO, a.NTT_CN,
			a.PASSWORD, a.FRST_REGISTER_ID, b.USER_NM as FRST_REGISTER_NM,
			DATE_FORMAT(a.FRST_REGIST_PNTTM, '%Y-%m-%d') as FRST_REGIST_PNTTM,
			a.NTCE_BGNDE, a.NTCE_ENDDE, a.RDCNT,
			a.USE_AT, a.ATCH_FILE_ID, a.BBS_ID, a.NTT_ID,
			a.PARNTSCTT_NO, a.ANSWER_AT, a.ANSWER_LC, a.SORT_ORDR,
			c.BBS_TY_CODE, c.BBS_ATTRB_CODE, c.REPLY_POSBL_AT,
			c.FILE_ATCH_POSBL_AT, c.ATCH_POSBL_FILE_NUMBER, c.BBS_NM, a.TEAM_NM, a.IMG_URL, a.SELECT_IMG
			, (SELECT IFNULL((SELECT d.score FROM lettnbbsscore d WHERE d.NTT_ID = a.NTT_ID AND d.BBS_ID = a.BBS_ID AND d.WRTER_ID = #{exmnId} AND d.USE_AT = 'Y' LIMIT 1), 0)) AS SCORE
			, (SELECT IFNULL((SELECT ROUND(AVG(d.score), 1) FROM lettnbbsscore d WHERE d.NTT_ID = a.NTT_ID AND d.BBS_ID = a.BBS_ID AND d.USE_AT = 'Y' LIMIT 1), 0)) AS SCORE_A
			, (SELECT count(1) FROM lettnbbsscore d WHERE d.NTT_ID = a.NTT_ID AND d.BBS_ID = a.BBS_ID AND d.USE_AT = 'Y' LIMIT 1) AS SCORE_CNT
	    	, (SELECT count(1) FROM lettncomment d WHERE d.NTT_ID = a.NTT_ID AND d.BBS_ID = a.BBS_ID AND d.USE_AT = 'Y' LIMIT 1) AS COMMENT_CNT
		FROM
			LETTNBBS a
				LEFT OUTER JOIN
			COMVNUSERMASTER b
			ON a.FRST_REGISTER_ID = b.ESNTL_ID
				LEFT OUTER JOIN
			LETTNBBSMASTER c
			ON a.BBS_ID = c.BBS_ID
		WHERE
			a.BBS_ID = #{bbsId}
		  AND
			a.NTT_ID = #{nttId}

	</select>

	<update id="updateBoardArticle" parameterType="egovframework.let.cop.bbs.service.Board">
 		
			UPDATE LETTNBBS SET 
				NTT_SJ = #{nttSj},
				NTT_CN = #{nttCn}, 
				NTCR_ID = #{ntcrId},
				NTCR_NM = #{ntcrNm},
				PASSWORD = #{password},
				NTCE_BGNDE = #{ntceBgnde},		
				NTCE_ENDDE = #{ntceEndde},
				LAST_UPDUSR_ID = #{lastUpdusrId},
				ATCH_FILE_ID = #{atchFileId},
				LAST_UPDT_PNTTM = SYSDATE(),
				TEAM_NM = #{teamNm},
				IMG_URL = #{imgUrl},
				SELECT_IMG = #{selectImg}
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
 		
 	</update>

 	<update id="deleteBoardArticle" parameterType="egovframework.let.cop.bbs.service.Board">
 		
			UPDATE LETTNBBS SET 
				NTT_SJ = #{nttSj},
				USE_AT = 'N',
				LAST_UPDUSR_ID = #{lastUpdusrId},
				LAST_UPDT_PNTTM = SYSDATE()
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
 		
 	</update>

 	<select id="selectMaxInqireCo" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultType="java.lang.Integer">
 		
			SELECT IFNULL(MAX(RDCNT),0)+1 AS RDCNT FROM LETTNBBS
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
 		
 	</select>
 	
 	<select id="selectNoticeItemForSort" parameterType="egovframework.let.cop.bbs.service.Board" resultType="java.lang.Long">
 		
			SELECT
				IFNULL(MAX(NTT_NO),0)+1 AS NTT_NO
			FROM
				LETTNBBS	
			WHERE
				BBS_ID = #{bbsId}
			AND
				SORT_ORDR = #{sortOrdr}
			AND 
				NTT_ID = #{nttId}	
 		
 	</select> 	

 	<update id="updateInqireCo" parameterType="egovframework.let.cop.bbs.service.BoardVO">
 		
			UPDATE LETTNBBS SET 
				RDCNT = #{inqireCo}
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
 		
 	</update>

	<update id="updateSortOrder" parameterType="egovframework.let.cop.bbs.service.BoardVO">
 		
			UPDATE LETTNBBS SET 
				NTT_NO = #{nttNo}
			WHERE NTT_ID = #{nttId}
 			
	</update>

	<select id="selectGuestList" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="guestList">
		
			SELECT
				a.NTT_ID, a.NTT_SJ, a.NTCR_NM, a.PASSWORD, 
				DATE_FORMAT(a.FRST_REGIST_PNTTM, '%Y-%m-%d %H:%i:%S') 
				as FRST_REGIST_PNTTM,
				a.NTT_CN, a.USE_AT, a.BBS_ID, b.USER_NM as FRST_REGISTER_NM, a.FRST_REGISTER_ID
			FROM
				LETTNBBS a, COMVNUSERMASTER b
			WHERE
				a.BBS_ID = #{bbsId}
			AND 
				a.FRST_REGISTER_ID = b.ESNTL_ID
			AND
				a.USE_AT = 'Y'
			ORDER BY a.SORT_ORDR DESC, a.NTT_NO ASC
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
						
	</select>	
	
	<select id="selectGuestListCnt" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultType="java.lang.Integer">
		
			SELECT
				COUNT(NTT_ID)
			FROM
				LETTNBBS 
			WHERE
				BBS_ID = #{bbsId}	
			AND
				USE_AT = 'Y'
					
	</select>	

	<update id="deleteGuestList" parameterType="egovframework.let.cop.bbs.service.BoardVO">
		
			UPDATE LETTNBBS
			SET USE_AT = 'N'
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
					
	</update>	
	
	<select id="getPasswordInf" parameterType="egovframework.let.cop.bbs.service.Board" resultType="java.lang.String">
		
			SELECT
				PASSWORD
			FROM
				LETTNBBS	
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}				
		
	</select>

	<select id="getParentNttNo" parameterType="egovframework.let.cop.bbs.service.Board" resultType="java.lang.Long">
		
			SELECT NTT_NO FROM LETTNBBS
			WHERE BBS_ID = #{bbsId} AND NTT_ID = #{parnts}			
		
	</select>
	
 	<update id="updateOtherNttNo" parameterType="egovframework.let.cop.bbs.service.Board">
 		
			UPDATE LETTNBBS SET 
				NTT_NO = NTT_NO + 1
			WHERE BBS_ID = #{bbsId} AND SORT_ORDR = #{sortOrdr}
			AND NTT_NO &gt; #{nttNo}
 		
 	</update>
 	
	<update id="updateNttNo" parameterType="egovframework.let.cop.bbs.service.Board">
 		
			UPDATE LETTNBBS SET 
				NTT_NO = #{nttNo}
			WHERE BBS_ID = #{bbsId} 
			AND NTT_ID = #{nttId}
 		
 	</update>

	<select id="selectBoardArticleFileRdcnt" parameterType="egovframework.let.cop.bbs.service.Board" resultType="java.lang.String">

		SELECT
			RDCNT
		FROM
			LETTNFILEDETAIL
		WHERE ATCH_FILE_ID = #{atchFileId}

	</select>

	<select id="selectBoardArticleVisitRdcnt" parameterType="egovframework.let.cop.bbs.service.Board" resultType="java.lang.String">

		SELECT
			NEXT_ID
		FROM
			IDS
		WHERE TABLE_NAME = 'VISIT_COUNT_ID'
	</select>

	<select id="selectBbsByValtAjax" parameterType="egovframework.let.cont.valt.service.ContValtVO" resultMap="valtBbsList">
		SELECT B.BBS_ID AS BBS_ID,
		       B.NTT_ID AS NTT_ID,
		       A.NTT_SJ AS NTT_SJ,
		       A.TEAM_NM AS TEAM_NM,
		       C.USER_NM AS NTCR_NM
		FROM LETTNBBS A
		JOIN TB_VALT_TAR_MNGM B
			ON A.BBS_ID = B.BBS_ID AND A.NTT_ID = B.NTT_ID
		JOIN COMVNUSERMASTER C
			ON A.FRST_REGISTER_ID = C.ESNTL_ID
		WHERE B.VALT_MNGM_NO = #{valtMngmNo}
			AND B.USE_AT = #{useAt}
			AND A.USE_AT = 'Y'
		ORDER BY B.NTT_ID
	</select>

	<select id="selectBbsByValtTotCntAjax" parameterType="egovframework.let.cont.valt.service.ContValtVO" resultType="java.lang.Integer">
		SELECT COUNT(1)
		FROM LETTNBBS A
				 JOIN TB_VALT_TAR_MNGM B
					  ON A.BBS_ID = B.BBS_ID AND A.NTT_ID = B.NTT_ID
				 JOIN COMVNUSERMASTER C
					  ON A.FRST_REGISTER_ID = C.ESNTL_ID
		WHERE B.VALT_MNGM_NO = #{valtMngmNo}
		  AND B.USE_AT = #{useAt}
		  AND A.USE_AT = 'Y'
		ORDER BY B.NTT_ID
	</select>

	<select id="selectMaxCmtId" resultType="java.lang.Long">

		SELECT IFNULL(MAX(ANSWER_NO),0)+1 AS ANSWER_NO
		FROM LETTNCOMMENT
		WHERE BBS_ID = #{bbsId}
		  AND NTT_ID = #{nttId}

	</select>

	<insert id="insertBoardComment" parameterType="egovframework.let.cop.bbs.service.Board">
		<selectKey keyProperty="answerNo" resultType="java.lang.Long" order="BEFORE">
			SELECT IFNULL(MAX(ANSWER_NO),0)+1 AS ANSWER_NO  FROM LETTNCOMMENT
			WHERE BBS_ID = #{bbsId} AND NTT_ID = #{nttId}
		</selectKey>

		INSERT INTO LETTNCOMMENT
		(NTT_ID, BBS_ID, ANSWER_NO, WRTER_ID, WRTER_NM, ANSWER, USE_AT
		, FRST_REGISTER_ID, FRST_REGIST_PNTTM)
		VALUES
		(#{nttId}, #{bbsId}, #{answerNo}, #{exmnId}, '', #{answer}, #{useAt}
		  , #{frstRegisterId}, SYSDATE())

	</insert>

	<select id="selectBoardCommentList" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="commentList">

		SELECT
			a.NTT_ID,
			a.BBS_ID,
			a.ANSWER_NO,
			a.WRTER_ID AS NTCR_ID,
			a.ANSWER,
			a.USE_AT,
			a.FRST_REGIST_PNTTM,
			a.FRST_REGISTER_ID,
			b.IMG_URL,
			b.MBER_NM AS NTCR_NM,
			SUBSTRING_INDEX(c.CODE_NM, '>', -1) AS TEAM_NM,
			d.CODE_NM AS TITLE_NM
		FROM
			LETTNCOMMENT a
			INNER JOIN LETTNGNRLMBER b on a.WRTER_ID = b.MBER_ID
			LEFT OUTER JOIN lettccmmndetailcode c on b.DEPT_CODE = c.code and c.CODE_ID = 'IBK001'
			LEFT OUTER JOIN lettccmmndetailcode d on b.TITLE_CODE = d.code and d.CODE_ID = 'IBK002'
		WHERE
			a.BBS_ID = #{bbsId}
		  AND a.NTT_ID = #{nttId}
		  AND a.USE_AT = 'Y'
		ORDER BY a.ANSWER_NO DESC
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}

	</select>

	<select id="selectBoardCommentCnt" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultType="java.lang.Integer">

		SELECT
			COUNT(NTT_ID)
		FROM
			LETTNCOMMENT
		where BBS_ID = #{bbsId} and NTT_ID = #{nttId} AND USE_AT = 'Y'

	</select>

	<select id="selectBoardCommentMoreList" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="commentList">

		SELECT
			a.NTT_ID,
			a.BBS_ID,
			a.ANSWER_NO,
			a.WRTER_ID AS NTCR_ID,
			a.ANSWER,
			a.USE_AT,
			a.FRST_REGIST_PNTTM,
			a.FRST_REGISTER_ID,
			b.IMG_URL,
			b.MBER_NM AS NTCR_NM,
			SUBSTRING_INDEX(c.CODE_NM, '>', -1) AS TEAM_NM,
			d.CODE_NM AS TITLE_NM
		FROM
			LETTNCOMMENT a
				INNER JOIN LETTNGNRLMBER b on a.WRTER_ID = b.MBER_ID
				LEFT OUTER JOIN lettccmmndetailcode c on b.DEPT_CODE = c.code and c.CODE_ID = 'IBK001'
				LEFT OUTER JOIN lettccmmndetailcode d on b.TITLE_CODE = d.code and d.CODE_ID = 'IBK002'
		WHERE
			a.BBS_ID = #{bbsId}
		  AND a.NTT_ID = #{nttId}
		  AND a.USE_AT = 'Y'
		  AND a.ANSWER_NO &lt; #{answerNo}
		ORDER BY a.ANSWER_NO DESC
			LIMIT 10 OFFSET 0

	</select>

	<select id="selectBoardCommentMoreCnt" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultType="java.lang.Integer">

		SELECT
			COUNT(NTT_ID)
		FROM
			LETTNCOMMENT
		where BBS_ID = #{bbsId} and NTT_ID = #{nttId} AND USE_AT = 'Y' AND ANSWER_NO &lt; #{answerNo}

	</select>

	<update id="updateBoardComment" parameterType="egovframework.let.cop.bbs.service.BoardVO">

		UPDATE LETTNCOMMENT SET
			ANSWER = #{answer},
			USE_AT = #{useAt},
			LAST_UPDUSR_ID = #{lastUpdusrId},
			LAST_UPDT_PNTTM = SYSDATE()
		WHERE BBS_ID = #{bbsId}
		  AND NTT_ID = #{nttId}
		  AND ANSWER_NO = #{answerNo}
		  AND WRTER_ID = #{exmnId}

	</update>

	<select id="selectBoardScoreList" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultMap="scoreList">

		SELECT s.SCORE,
			   COALESCE(cnt.SCORE_CNT, 0) AS SCORE_CNT
		FROM (
				 SELECT 1 AS SCORE UNION ALL
				 SELECT 2 UNION ALL
				 SELECT 3 UNION ALL
				 SELECT 4 UNION ALL
				 SELECT 5
			 ) s
				 LEFT JOIN (
			SELECT SCORE, COUNT(1) AS SCORE_CNT
			FROM lettnbbsscore
			WHERE BBS_ID = #{bbsId} AND NTT_ID = #{nttId} AND USE_AT = 'Y'
			GROUP BY SCORE
		) cnt ON s.SCORE = cnt.SCORE
		ORDER BY s.SCORE ASC
	</select>

	<select id="selectBoardScoreCnt" parameterType="egovframework.let.cop.bbs.service.BoardVO" resultType="java.lang.Integer">
		SELECT count(1) as cnt FROM (
										SELECT s.SCORE,
											   COALESCE(cnt.SCORE_CNT, 0) AS SCORE_CNT
										FROM (
												 SELECT 1 AS SCORE UNION ALL
												 SELECT 2 UNION ALL
												 SELECT 3 UNION ALL
												 SELECT 4 UNION ALL
												 SELECT 5
											 ) s
												 LEFT JOIN (
											SELECT SCORE, COUNT(1) AS SCORE_CNT
											FROM lettnbbsscore
											WHERE BBS_ID = #{bbsId} AND NTT_ID = #{nttId} AND USE_AT = 'Y'
											GROUP BY SCORE
										) cnt ON s.SCORE = cnt.SCORE
									) aaa
	</select>
</mapper>